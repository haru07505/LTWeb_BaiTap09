<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Product Management - GraphQL</title>
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<style>
body { padding: 20px; background: #f9f9f9; }
h1 { margin-bottom: 20px; }
</style>
</head>
<body>
<div class="container">
  <h1 class="text-primary">GraphQL Product Management</h1>

  <!-- Filter -->
  <div class="mb-3 d-flex align-items-center gap-2">
    <button class="btn btn-secondary" onclick="loadProductsSorted()">Sort by Price â†‘</button>
    <select id="categorySelect" class="form-select" style="max-width:300px">
      <option value="">-- All Categories --</option>
    </select>
  </div>

  <!-- Product CRUD -->
  <h3>Products</h3>
  <button class="btn btn-primary mb-2" onclick="showAddProductRow()">+ Add Product</button>
  <table class="table table-bordered" id="prodTable">
    <thead>
      <tr>
        <th>ID</th><th>Title</th><th>Price</th><th>Qty</th>
        <th>Description</th><th>Owner</th><th>Category</th><th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const GRAPHQL = '/graphql';

// ========== HELPER ==========
async function gql(query, variables={}) {
  const res = await fetch(GRAPHQL, {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ query, variables })
  });
  const j = await res.json();
  if (j.errors) { alert(j.errors.map(e => e.message).join(", ")); throw new Error(j.errors[0].message); }
  return j.data;
}

// ========== RENDER ==========
function renderTable(list){
  const tbody=document.querySelector("#prodTable tbody");
  tbody.innerHTML="";
  list.forEach(p=>{
    const cat = p.category ? p.category.name : '';
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${p.id}</td>
      <td>${p.title}</td>
      <td>${p.price}</td>
      <td>${p.quantity||''}</td>
      <td>${p.description||''}</td>
      <td>${p.owner? p.owner.fullname:''}</td>
      <td>${cat}</td>
      <td>
        <button class="btn btn-sm btn-warning" onclick="editProduct(${p.id},'${p.title}',${p.price},${p.quantity||0},'${p.description||''}')">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="deleteProduct(${p.id})">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

// ========== PRODUCT ==========
async function loadProductsTable() {
  const q = `query { products { id title price quantity description owner {fullname} category {id name} } }`;
  const d = await gql(q);
  renderTable(d.products);
}

function showAddProductRow() {
  const tbody=document.querySelector("#prodTable tbody");
  const tr=document.createElement("tr");
  tr.innerHTML=`
    <td>new</td>
    <td><input id="newProdTitle" class="form-control"></td>
    <td><input id="newProdPrice" type="number" class="form-control"></td>
    <td><input id="newProdQty" type="number" class="form-control"></td>
    <td><input id="newProdDesc" class="form-control"></td>
    <td><input id="newProdOwner" class="form-control" placeholder="Owner ID"></td>
    <td><input id="newProdCategory" class="form-control" placeholder="Category ID (comma)"></td>
    <td><button class="btn btn-sm btn-success" onclick="createProduct()">Save</button></td>`;
  tbody.prepend(tr);
}

async function createProduct(){
  const inp={
    title:document.getElementById("newProdTitle").value,
    price:parseFloat(document.getElementById("newProdPrice").value),
    quantity:parseInt(document.getElementById("newProdQty").value),
    description:document.getElementById("newProdDesc").value,
    ownerId:document.getElementById("newProdOwner").value,
    categoryId: document.getElementById("newProdCategory").value
                  .split(",")
                  .map(x=>x.trim())
                  .filter(x=>x)
  };
  const q=`mutation($inp:CreateProductInput!){ createProduct(input:$inp){id} }`;
  await gql(q,{inp}); await loadProductsTable();
}

function editProduct(id,title,price,qty,desc){
  const row=[...document.querySelectorAll("#prodTable tbody tr")].find(tr=>tr.cells[0].innerText==id);
  row.innerHTML=`
    <td>${id}</td>
    <td><input value="${title}" id="editProdTitle${id}" class="form-control"></td>
    <td><input value="${price}" id="editProdPrice${id}" type="number" class="form-control"></td>
    <td><input value="${qty}" id="editProdQty${id}" type="number" class="form-control"></td>
    <td><input value="${desc}" id="editProdDesc${id}" class="form-control"></td>
    <td colspan="2"></td>
    <td>
      <button class="btn btn-sm btn-success" onclick="updateProduct(${id})">Save</button>
      <button class="btn btn-sm btn-secondary" onclick="loadProductsTable()">Cancel</button>
    </td>`;
}

async function updateProduct(id){
  const inp={
    title:document.getElementById("editProdTitle"+id).value,
    price:parseFloat(document.getElementById("editProdPrice"+id).value),
    quantity:parseInt(document.getElementById("editProdQty"+id).value),
    description:document.getElementById("editProdDesc"+id).value,
    categoryId: document.getElementById("editProdCategory"+id)?.value
  };
  const q=`mutation($id:ID!,$inp:UpdateProductInput!){ updateProduct(id:$id,input:$inp){id} }`;
  await gql(q,{id,inp}); await loadProductsTable();
}

async function deleteProduct(id){
  const q=`mutation($id:ID!){ deleteProduct(id:$id) }`;
  await gql(q,{id}); await loadProductsTable();
}

// ========== FILTER ==========
async function loadProductsSorted(){
  const q=`query{ productsSortedByPrice {id title price quantity description owner{fullname} category{id name}} }`;
  const d=await gql(q);
  renderTable(d.productsSortedByPrice);
}

async function loadCategoriesDropdown(){
  const q=`query{ categories {id name} }`;
  const d=await gql(q);
  const sel=document.getElementById("categorySelect");
  sel.innerHTML='<option value="">-- All Categories --</option>';
  d.categories.forEach(c=>{
    const o=document.createElement("option"); o.value=c.id; o.text=c.name; sel.appendChild(o);
  });
}

async function loadProductsByCategory(cid){
  if(!cid){ await loadProductsTable(); return;}
  const q=`query($cid:ID!){ productsByCategory(categoryId:$cid){id title price quantity description owner{fullname} category{name}} }`;
  const d=await gql(q,{cid});
  renderTable(d.productsByCategory);
}
document.getElementById('categorySelect').addEventListener('change',e=>loadProductsByCategory(e.target.value));

// INIT
(async()=>{ await loadProductsTable(); await loadCategoriesDropdown(); })();
</script>
</body>
</html>
